<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Quiet Routes Astana — Ras2</title>
<meta name="description" content="Тихие маршруты, места и поддержка в Астане (демо SPA с хэш-роутером)." />
<style>
  :root{
    --bg:#f7f5fb; --card:#ffffff; --ink:#1f2430; --muted:#6a7280; --border:#e6e1ff;
    --accent:#6b5ae0; --accent-2:#18a999; --danger:#e03b5a; --soft:#efeaff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Roboto,Arial}
  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}
  header{position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--border)}
  nav{max-width:1200px; margin:0 auto; padding:10px 14px; display:flex; flex-wrap:wrap; gap:8px}
  nav a{padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; font-weight:600; font-size:14px}
  nav a.active{background:var(--soft); border-color:#cfc6ff}
  main{max-width:1200px; margin:0 auto; padding:14px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:10px}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:0 1px 2px rgba(20,10,60,.04); margin-bottom:12px}
  h1{font-size:22px; margin:8px 0}
  h2{font-size:18px; margin:8px 0}
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:4px}
  input, select, button, textarea{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:#fff; font-size:15px}
  textarea{min-height:100px}
  .btn{background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer}
  .btn.secondary{background:#fff; color:var(--accent); border:1px solid var(--border)}
  .btn.ghost{background:transparent; border:1px dashed #cfc6ff; color:#6a7280}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px}
  .pill .dot{width:8px; height:8px; border-radius:50%; background:var(--accent-2)}
  .muted{color:var(--muted); font-size:13px}
  .notice{background:#f8fafc; border:1px solid #e6eef8; border-radius:12px; padding:10px; color:#41566b; font-size:13px}
  .map{position:relative; width:100%; height:340px; background:#e9eef6; border:1px solid #cfd7e6; border-radius:14px; overflow:hidden}
  /* карта и её слои — не перехватывают клики внешнего UI */
  .map, .map * { pointer-events: none; }
  .map .legend{position:absolute; right:10px; top:10px; background:#ffffffcc; border:1px solid #e6eef8; border-radius:8px; padding:6px 8px; font-size:12px; pointer-events:auto}
  .map svg{position:absolute; inset:0}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .chip{padding:8px 10px; border:1px solid var(--border); border-radius:999px; font-size:13px; cursor:pointer; background:#fff}
  .chip.active{background:var(--soft); border-color:#cfc6ff}
  .hidden{display:none !important}
  .split{display:grid; grid-template-columns:1.2fr .8fr; gap:10px}
  @media(max-width:900px){ .split{grid-template-columns:1fr} }
  .hero{display:grid; grid-template-columns:1.2fr .8fr; gap:12px}
  @media(max-width:900px){ .hero{grid-template-columns:1fr} }
  .meter{background:#ede9ff; border-radius:10px; overflow:hidden; height:10px}
  .meter>div{height:100%; width:0; background:linear-gradient(90deg,#6b5ae0,#8f7fff)}
  footer{max-width:1200px; margin:20px auto 30px; padding:0 14px; color:var(--muted); font-size:12px}
  .quiet-theme{filter:brightness(.95) saturate(.9)}

  /* Детский режим */
  #view-kids .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); }
  #view-kids .row { display:flex; align-items:center; gap:10px; margin:8px 0; }
  #view-kids details { margin:12px 0; }
  #view-kids input, #view-kids select { width:100%; }
  .dino-select { display:flex; gap:16px; flex-wrap:wrap; }
  .dino-select label { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid #ffd1e3; border-radius:12px; cursor:pointer; }
  .dino-select img { width:44px; height:44px; display:block; }
  .dino-select input { accent-color:#ff4f8a; }
  .kid-actions { display:flex; gap:12px; margin:12px 0; }
  #btnTest, #btnSOS { padding:12px 16px; border:none; border-radius:10px; font-weight:600; }
  #btnTest { background:#ffd1e3; }
  #btnSOS { background:#ff4f8a; color:#fff; }
  #btnSOS.sos { animation:pulse 1.6s infinite; }
  @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.04)} 100%{transform:scale(1)} }
  .kid-cursor { width:40px; height:40px; position:absolute; transform:translate(-50%,-50%); pointer-events:none; animation:bob 1.2s ease-in-out infinite; }
  @keyframes bob { 0%,100%{ transform:translate(-50%,-52%)} 50%{ transform:translate(-50%,-48%)} }
</style>
</head>
<body>

<header>
  <nav id="nav">
    <a href="#/" data-view="home">Главная страница</a>
    <a href="#/routes" data-view="routes">Навигатор</a>
    <a href="#/places" data-view="places">Тихие места</a>
    <a href="#/planner" data-view="planner">Планирование</a>
    <a href="#/alarm" data-view="alarm">Тревога</a>
    <a href="#/volunteer" data-view="volunteer">Волонтёры</a>
    <a href="#/crowd" data-view="crowd">Краудсорсинг</a>
    <a href="#/about" data-view="about">О проекте</a>
    <a href="#/kids" data-view="kids">Детский режим</a>
  </nav>
</header>

<!-- Детский режим -->
<section id="view-kids" class="hidden">
  <h2>Детский режим</h2>
  <label class="row">
    <input type="checkbox" id="kidModeToggle">
    <span>Включить детский режим (отслеживание и оповещения)</span>
  </label>

  <details>
    <summary>Настройки оповещений</summary>
    <div class="grid">
      <label>Способ:
        <select id="notifyMethod">
          <option value="telegram">Telegram Bot</option>
          <option value="webhook">Мой Webhook URL</option>
        </select>
      </label>

      <div id="telegramBlock">
        <label>BOT_TOKEN
          <input type="password" id="tgToken" placeholder="123456:ABC-DEF...">
        </label>
        <label>CHAT_ID
          <input type="text" id="tgChat" placeholder="Напр. 123456789">
        </label>
      </div>

      <div id="webhookBlock" class="hidden">
        <label>WEBHOOK_URL
          <input type="url" id="webhookUrl" placeholder="https://my-server.example/hook">
        </label>
      </div>

      <label>Интервал отправки (сек.)
        <input type="number" id="sendInterval" min="10" step="5" value="60">
      </label>
    </div>
  </details>

  <details>
    <summary>Динозавр вместо стрелки</summary>
    <div class="dino-select">
      <label>
        <input type="radio" name="dino" value="rex" checked>
        <img src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M8 40h20l6 6 6-6h16v8H8z' fill='%23ff4f8a'/><circle cx='24' cy='28' r='10' fill='%23ff82ab'/><circle cx='28' cy='26' r='2' fill='%23000'/></svg>" alt="Rex">
        <span>Рекс</span>
      </label>
      <label>
        <input type="radio" name="dino" value="stego">
        <img src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M6 42h24l4 4 4-4h20v6H6z' fill='%23ff4f8a'/><path d='M12 32l6-6 6 6 6-6 6 6' stroke='%23ff82ab' stroke-width='6' fill='none'/></svg>" alt="Stego">
        <span>Стего</span>
      </label>
      <label>
        <input type="radio" name="dino" value="bronto">
        <img src="data:image/svg+xml;utf8,<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M10 40h22c8 0 10-8 18-8h4v10H10z' fill='%23ff4f8a'/><path d='M40 22c6 0 6 8 6 12' stroke='%23ff82ab' stroke-width='6' fill='none'/></svg>" alt="Bronto">
        <span>Бронто</span>
      </label>
    </div>
  </details>

  <div class="kid-actions">
    <button id="btnTest">Отправить тестовое сообщение</button>
    <button id="btnSOS" class="sos">SOS</button>
  </div>

  <p class="hint">Статус: <span id="kidStatus">выключено</span></p>
</section>
  
<main>
  <!-- HOME -->
  <section id="view-home" class="view">
    <div class="hero">
      <div class="card">
        <div class="row" style="align-items:center">
          <h1 style="margin:0">Комфортный и тихий путь</h1>
          <span class="pill"><span class="dot"></span> Астана</span>
          <button class="btn secondary" id="toggleQuiet" style="margin-left:auto">Тихая тема</button>
        </div>
        <p>Quiet Routes — альтернативные пешеходные маршруты, которые <strong>избегают шумных/многолюдных/ярких</strong> зон и подбирают <strong>тихие места</strong>. Сделано для людей с РАС и высокой сенсорной чувствительностью. Сделайте свою доорогу спокойной и комфортной.</p>
        <div class="row">
          <a class="btn" href="#/routes">Построить маршрут</a>
          <a class="btn secondary" href="#/places">Тихие места</a>
        </div>
      </div>
      <div class="card">
        <div class="map" aria-label="Карта Астаны (макет)">
          <div class="legend">Синие — тихо · Красные — шумно · Жёлтые — экраны</div>
          <svg viewBox="0 0 600 340" preserveAspectRatio="none">
            <g fill="#e6edf7" stroke="#cfd7e6"><rect x="10" y="10" width="580" height="320" rx="16"/></g>
            <path d="M0,200 C150,210 250,180 600,210" stroke="#9ed0ff" stroke-width="14" fill="none" opacity=".8"/>
            <g fill="#e03b5a"><circle cx="200" cy="100" r="36" opacity=".18"/><circle cx="460" cy="120" r="40" opacity=".18"/></g>
            <g fill="#ffd54f"><rect x="370" y="150" width="60" height="26" opacity=".2"/></g>
            <g stroke="#6b5ae0" stroke-width="4" fill="none">
              <path d="M80,300 C180,260 280,240 380,220 460,200 520,190 560,180"/>
              <path d="M120,260 C200,240 260,220 330,210" stroke-dasharray="6 6"/>
            </g>
          </svg>
        </div>
      </div>
    </div>
  </section>

  <!-- ROUTES -->
  <section id="view-routes" class="view hidden">
    <div class="split">
      <div class="card">
        <h2>Маршрут A → B (тихий)</h2>
        <div class="row">
          <div style="flex:1"><label>Откуда</label><input id="from" value="ул. Манаса 17"></div>
          <div style="flex:1"><label>Куда</label><input id="to" value="Поликлиника №9"></div>
        </div>
        <div class="chips" style="margin-top:6px">
          <div class="chip active" data-k="noise">чувств. к шуму</div>
          <div class="chip active" data-k="crowd">к толпе</div>
          <div class="chip" data-k="light">к яркому свету</div>
          <div class="chip" data-k="cross">к крупным перекрёсткам</div>
          <div class="chip active" data-k="parks">парки</div>
          <div class="chip active" data-k="yards">дворы</div>
          <div class="chip" data-k="paths">пешеходные дорожки</div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="build">Построить тихий маршрут</button>
          <button class="btn secondary" id="alt">Альтернатива</button>
          <button class="btn secondary" id="exportRoute">Экспорт .txt</button>
          <button class="btn" id="startNav">Запустить навигацию</button>
        </div>
        <div class="map" style="margin-top:10px">
          <div class="legend">Тихие — сплошная · Нейтральные — пунктир · Избегать — красный</div>
          <svg viewBox="0 0 600 340" preserveAspectRatio="none">
            <g id="heatLoud" fill="#e03b5a"><circle cx="460" cy="100" r="44" opacity=".18"/><rect x="10" y="320" width="580" height="24" rx="12" opacity=".16"/></g>
            <g id="heatLight" fill="#ffd54f"><rect x="260" y="180" width="70" height="26" opacity=".16"/></g>
            <g id="corridors" stroke="#6b5ae0" stroke-width="4" fill="none">
              <path id="seg1" d="M40,300 C140,260 200,230 300,210" />
              <path id="seg2" d="M300,210 C360,200 420,180 520,160" stroke-dasharray="6 6"/>
              <path id="segBad" d="M10,330 L590,330" stroke="#e03b5a66" stroke-width="6"/>
            </g>
            <g id="routeLine" stroke="#6b5ae0" stroke-width="5" fill="none">
              <path id="rMain" d="M40,300 C140,260 200,230 300,210 360,200 420,180 520,160" />
              <circle cx="40" cy="300" r="6" fill="#18a999"/>
              <circle cx="520" cy="160" r="6" fill="#18a999"/>
            </g>
          </svg>
        </div>
        <div class="notice" style="margin-top:8px">Алгоритм демо: штрафует магистрали и «горячие точки», поощряет парки/дворы; учитывает текущий час.</div>
      </div>
      <div class="card">
        <h2>Шаги</h2>
        <div id="steps" class="grid">
          <div class="card" style="border-style:dashed"><strong>Через двор</strong><div class="muted">150 м · низкий шум</div></div>
          <div class="card" style="border-style:dashed"><strong>Через парк</strong><div class="muted">500 м · зелёная зона</div></div>
          <div class="card" style="border-style:dashed"><strong>Небольшая улица</strong><div class="muted">300 м · возможен шум вечером</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PLACES -->
  <section id="view-places" class="view hidden">
    <div class="split">
      <div class="card">
        <h2>Тихие места (Астана)</h2>
        <div class="chips">
          <div class="chip active" data-f="open">Открыты</div>
          <div class="chip" data-f="music">Без музыки</div>
          <div class="chip" data-f="light">Мягкий свет</div>
          <div class="chip" data-f="wc">Санузел</div>
        </div>
        <div id="placeList" class="grid" style="margin-top:8px"></div>
      </div>
      <div class="card">
        <h2>Карта</h2>
        <div class="map">
          <div class="legend">Маркеры — тихие точки</div>
          <svg viewBox="0 0 600 340" preserveAspectRatio="none">
            <g fill="#e6edf7" stroke="#cfd7e6"><rect x="10" y="10" width="580" height="320" rx="16"/></g>
            <path d="M0,200 C150,210 250,180 600,210" stroke="#9ed0ff" stroke-width="14" fill="none" opacity=".8"/>
            <g id="poiLayer" fill="#18a999" stroke="#fff" stroke-width="2"></g>
          </svg>
        </div>
      </div>
    </div>
  </section>

  <!-- PLANNER -->
  <section id="view-planner" class="view hidden">
    <div class="split">
      <div class="card">
        <h2>Планировщик визита</h2>
        <div class="row">
          <div><label>Дата</label><input type="date" id="pDate"/></div>
          <div><label>Время</label><input type="time" id="pTime" value="11:00"/></div>
        </div>
        <div class="row" style="margin-top:6px">
          <div><label>Точка A</label><input id="pA" value="Дом (Сарыарка)"/></div>
          <div><label>Точка B</label><input id="pB" value="Клиника на Керей-Жанибек хандар"/></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="pSuggest">Подобрать тихое окно</button>
          <button class="btn secondary" id="pSave">Сохранить</button>
          <button class="btn ghost" id="pExport">Экспорт .txt</button>
        </div>
        <div id="pOut" class="muted" style="margin-top:6px">—</div>
      </div>
      <div class="card">
        <h2>Чек-лист</h2>
        <div class="chips">
          <div class="chip active">Наушники</div>
          <div class="chip active">Солнечные очки</div>
          <div class="chip">Тихий режим телефона</div>
          <div class="chip">Вода/перекус</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ALARM -->
  <section id="view-alarm" class="view hidden">
    <div class="split">
      <div class="card">
        <h2>Тревога</h2>
        <p>Если чувствуете, что нужна помощь — отправьте геолокацию. Волонтёр будет рядом в ближайшее время.</p>
        <div class="row">
          <button class="btn" id="aSend" style="background:var(--danger)">Отправить геолокацию</button>
          <button class="btn" id="aShare">Поделиться маршрутом</button>
        </div>
        <div id="aStatus" class="notice" style="margin-top:8px">Ожидается отправка…</div>
      </div>
      <div class="card">
        <h2>Волонтёр в пути</h2>
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="pill"><span class="dot"></span> статус: ожидание</div>
          <div class="muted">обновление: —</div>
        </div>
        <div class="meter" style="margin-top:8px"><div id="aProg" style="width:0%"></div></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="aHelp">Показать советы</button>
          <button class="btn secondary" id="aMeet">Точка встречи</button>
        </div>
      </div>
    </div>
  </section>

  <!-- VOLUNTEER -->
  <section id="view-volunteer" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>Входящий вызов (волонтёр)</h2>
        <p class="muted">Как видит вызов волонтёр: мини-карта, приоритет, ETA, ответы.</p>
        <button class="btn" id="vOpen">Открыть экран волонтёра</button>
      </div>
      <div class="card">
        <h2>Проверка волонтёра</h2>
        <div class="row">
          <input id="code" placeholder="Код-слово от приложения"/>
          <button class="btn secondary" id="codeOk">Проверить</button>
        </div>
        <div id="codeOut" class="muted" style="margin-top:6px"></div>
      </div>
    </div>
  </section>

  <!-- CROWD -->
  <section id="view-crowd" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>Добавить тихое место</h2>
        <div class="row">
          <input id="cName" placeholder="Название (напр. Кафе «Лимон»)"/>
          <input id="cAddr" placeholder="Адрес/ориентир (Астана)"/>
        </div>
        <div class="row">
          <div class="chip" data-c="music">Без музыки</div>
          <div class="chip" data-c="light">Мягкий свет</div>
          <div class="chip" data-c="wc">Санузел</div>
          <div class="chip" data-c="seats">Спокойные места</div>
        </div>
        <textarea id="cDesc" placeholder="Почему тихо? Где лучше сидеть? Когда лучше приходить?"></textarea>
        <div class="row"><button class="btn" id="cSend">Отправить</button><button class="btn secondary" id="cClear">Очистить</button></div>
        <div id="cOut" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <h2>Оценить место</h2>
        <div class="row"><input id="rPlace" placeholder="Название места"/></div>
        <label>Шум</label><input id="rN" type="range" min="0" max="100" value="15">
        <label>Толпа</label><input id="rC" type="range" min="0" max="100" value="20">
        <label>Свет</label><input id="rL" type="range" min="0" max="100" value="10">
        <textarea id="rTxt" placeholder="Комментарий (необязательно)"></textarea>
        <div class="row"><button class="btn" id="rSend">Отправить оценку</button></div>
        <div id="rOut" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <h2>Жалоба / громкая точка</h2>
        <div class="row"><input id="gWhere" placeholder="Где? (ТРЦ, вход и т. п.)"/></div>
        <textarea id="gWhat" placeholder="Что происходит? (громкая музыка, яркие экраны…)"></textarea>
        <div class="row">
          <select id="gType"><option>шум</option><option>толпа</option><option>свет</option></select>
          <select id="gWhen"><option>утро</option><option selected>день</option><option>вечер</option><option>ночь</option></select>
        </div>
        <button class="btn" id="gSend" style="margin-top:6px">Отправить жалобу</button>
        <div id="gOut" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <h2>Лента / модерация</h2>
        <div class="row"><input id="mQ" placeholder="Поиск по ленте"><select id="mSort"><option value="new">новые</option><option value="calm">спокойные</option><option value="stress">проблемные</option></select></div>
        <div id="mFeed" class="grid" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="view-about" class="view hidden">
    <div class="grid">
      <div class="card">
        <h2>О проекте</h2>
        <p>Quiet Routes Astana — некоммерческая инициатива. Цель - сделать город безопасным местом для людей с расстройством аутического спектра, снизить сенсорную нагрузку в городе за счёт тихих маршрутов и мест. 
        Автор идеи и проекта - Бармина А.В. Связь - tg@abastassiyabr</p>
      </div>
    </div>
  </section>
</main>

<footer>
  Quiet Routes Astana · Ras · 2025
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log("JavaScript is running 🚀");

  // === Детский режим ===
  (function(){
    const els = {
      toggle: document.getElementById('kidModeToggle'),
      method: document.getElementById('notifyMethod'),
      tgToken: document.getElementById('tgToken'),
      tgChat: document.getElementById('tgChat'),
      webhookUrl: document.getElementById('webhookUrl'),
      telegramBlock: document.getElementById('telegramBlock'),
      webhookBlock: document.getElementById('webhookBlock'),
      sendInterval: document.getElementById('sendInterval'),
      btnTest: document.getElementById('btnTest'),
      btnSOS: document.getElementById('btnSOS'),
      status: document.getElementById('kidStatus')
    };

    const dinoRadios = document.querySelectorAll('input[name="dino"]');

    // маркер динозавра
    let dinoMarker = document.getElementById('dinoMarker');
    if(!dinoMarker){
      dinoMarker = document.createElement('div');
      dinoMarker.id = 'dinoMarker';
      dinoMarker.className = 'kid-cursor hidden';
      document.body.appendChild(dinoMarker);
    }

    const DINO_SVGS = {
      rex: "<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M8 40h20l6 6 6-6h16v8H8z' fill='%23ff4f8a'/><circle cx='24' cy='28' r='10' fill='%23ff82ab'/><circle cx='28' cy='26' r='2' fill='%23000'/></svg>",
      stego: "<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M6 42h24l4 4 4-4h20v6H6z' fill='%23ff4f8a'/><path d='M12 32l6-6 6 6 6-6 6 6' stroke='%23ff82ab' stroke-width='6' fill='none'/></svg>",
      bronto: "<?xml version='1.0'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M10 40h22c8 0 10-8 18-8h4v10H10z' fill='%23ff4f8a'/><path d='M40 22c6 0 6 8 6 12' stroke='%23ff82ab' stroke-width='6' fill='none'/></svg>"
    };

    function setDino(kind){
      const svg = DINO_SVGS[kind] || DINO_SVGS.rex;
      dinoMarker.style.backgroundImage = `url("data:image/svg+xml;utf8,${svg}")`;
      dinoMarker.style.backgroundSize = 'contain';
      dinoMarker.style.backgroundRepeat = 'no-repeat';
    }

    function updateMethodBlocks(){
      const m = els.method.value;
      els.telegramBlock.classList.toggle('hidden', m !== 'telegram');
      els.webhookBlock.classList.toggle('hidden', m !== 'webhook');
    }

    // загрузка настроек
    const saved = JSON.parse(localStorage.getItem('kid_opts') || '{}');
    if(els.toggle) els.toggle.checked = !!saved.enabled;
    if(els.method) els.method.value = saved.method || 'telegram';
    if(els.tgToken) els.tgToken.value = saved.tgToken || '';
    if(els.tgChat) els.tgChat.value = saved.tgChat || '';
    if(els.webhookUrl) els.webhookUrl.value = saved.webhookUrl || '';
    if(els.sendInterval) els.sendInterval.value = saved.interval || 60;

    if(dinoRadios.length){
      const toCheck = [...dinoRadios].find(r=>r.value === (saved.dino||'rex')) || dinoRadios[0];
      toCheck.checked = true;
    }
    setDino(saved.dino || 'rex');
    updateMethodBlocks();

    function save(){
      const chosenDino = [...dinoRadios].find(r=>r.checked)?.value || 'rex';
      const opts = {
        enabled: els.toggle?.checked,
        method: els.method?.value,
        tgToken: els.tgToken?.value.trim(),
        tgChat: els.tgChat?.value.trim(),
        webhookUrl: els.webhookUrl?.value.trim(),
        interval: Math.max(10, parseInt(els.sendInterval?.value||60,10)),
        dino: chosenDino
      };
      localStorage.setItem('kid_opts', JSON.stringify(opts));
      setDino(opts.dino);
      return opts;
    }

    dinoRadios.forEach(r=>r.addEventListener('change', save));
    ['change','input'].forEach(ev=>{
      els.toggle?.addEventListener(ev, onToggle);
      els.method?.addEventListener(ev, ()=>{ save(); updateMethodBlocks(); });
      els.tgToken?.addEventListener(ev, save);
      els.tgChat?.addEventListener(ev, save);
      els.webhookUrl?.addEventListener(ev, save);
      els.sendInterval?.addEventListener(ev, save);
    });

    // геолокация
    let watchId = null;
    let lastSent = 0;
    let lastPos = null;

    async function notifyParent(kind, coords, extra){
      const opts = JSON.parse(localStorage.getItem('kid_opts') || '{}');
      const ts = new Date().toISOString();
      const text = kind === 'SOS'
        ? `🚨 SOS!\nВремя: ${ts}\nШирота: ${coords?.latitude}\nДолгота: ${coords?.longitude}\nСкорость: ${coords?.speed||'—'}`
        : `📍 Отчёт движения\nВремя: ${ts}\nШирота: ${coords?.latitude}\nДолгота: ${coords?.longitude}\nСкорость: ${coords?.speed||'—'}`;

      try{
        if(opts.method === 'telegram' && opts.tgToken && opts.tgChat){
          const url = `https://api.telegram.org/bot${opts.tgToken}/sendMessage`;
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: opts.tgChat, text })
          });
        } else if(opts.method === 'webhook' && opts.webhookUrl){
          await fetch(opts.webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: kind, timestamp: ts, coords, extra })
          });
        }
      } catch(e){
        console.warn('Не удалось отправить уведомление', e);
      }
    }

    function onToggle(){
      const opts = save();
      if(opts.enabled){
        startTracking();
        els.status && (els.status.textContent = 'включено');
        dinoMarker.classList.remove('hidden');
      }else{
        stopTracking();
        els.status && (els.status.textContent = 'выключено');
        dinoMarker.classList.add('hidden');
      }
    }

    function startTracking(){
      if(!('geolocation' in navigator)){
        alert('Геолокация не поддерживается браузером');
        if(els.toggle) els.toggle.checked = false;
        save();
        return;
      }
      if(watchId !== null) return;
      watchId = navigator.geolocation.watchPosition(async (pos)=>{
        const { latitude, longitude, speed, accuracy } = pos.coords;
        lastPos = { latitude, longitude, speed, accuracy };
        // позиция курсора-динозавра (для демо — центр)
        dinoMarker.style.left = '50%';
        dinoMarker.style.top = '50%';

        const now = Date.now();
        const interval = Math.max(10, parseInt(els.sendInterval?.value||60,10))*1000;
        if(now - lastSent >= interval){
          lastSent = now;
          notifyParent('TICK', lastPos);
        }
      }, (err)=>{
        console.warn('Геолокация ошибка', err);
      }, {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 15000
      });
    }

    function stopTracking(){
      if(watchId !== null){
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
    }

    els.btnTest?.addEventListener('click', ()=>{
      notifyParent('TEST', lastPos || {latitude:null, longitude:null}, { note: 'probe' });
    });
    els.btnSOS?.addEventListener('click', ()=>{
      if(lastPos){
        notifyParent('SOS', lastPos);
      } else {
        navigator.geolocation.getCurrentPosition((pos)=>{
          const { latitude, longitude, speed, accuracy } = pos.coords;
          notifyParent('SOS', {latitude, longitude, speed, accuracy});
        }, ()=>notifyParent('SOS', {latitude:null, longitude:null}));
      }
    });

    if(els.toggle?.checked){ onToggle(); }
  })();

  // ---- Router ----
  const routes = ["home","routes","places","planner","alarm","volunteer","crowd","about","kids"];
  function setActive(view){
    document.querySelectorAll('nav a').forEach(a=>a.classList.toggle('active', a.dataset.view===view));
  }
  function show(view){
    routes.forEach(v=>{
      const section = document.getElementById('view-'+v);
      if(section) section.classList.add('hidden');
    });
    const activeView = document.getElementById('view-'+view);
    if(activeView) activeView.classList.remove('hidden');
    setActive(view);
    try{ localStorage.setItem('qr_last_view', view); }catch(e){}
  }
  function parseRoute(){
    const raw = location.hash || '#/';
    const m = raw.match(/^#\/?([^?]*)/);
    const segment = (m && m[1]) ? m[1] : '';
    const v = routes.includes(segment) ? segment : 'home';
    show(v);
  }
  window.addEventListener('hashchange', parseRoute);
  parseRoute();
  const lastView = localStorage.getItem('qr_last_view');
  if(lastView) show(lastView);

  // ---- Quiet theme ----
  const toggleBtn = document.getElementById('toggleQuiet');
  toggleBtn?.addEventListener('click', ()=> document.body.classList.toggle('quiet-theme'));

  // ---- Routes logic (demo) ----
  const chipsRoute = Array.from(document.querySelectorAll('#view-routes .chip'));
  chipsRoute.forEach(ch => ch.addEventListener('click', ()=> ch.classList.toggle('active')));

  function currentProfile(){
    const on = chipsRoute.filter(c=>c.classList.contains('active')).map(c=>c.dataset.k);
    return { noise:on.includes('noise'), crowd:on.includes('crowd'), light:on.includes('light'), cross:on.includes('cross'),
             parks:on.includes('parks'), yards:on.includes('yards'), paths:on.includes('paths') };
  }
  function timeBucket(){
    const h = new Date().getHours();
    if(h>=6 && h<10) return 'утро';
    if(h>=10 && h<16) return 'день';
    if(h>=16 && h<20) return 'вечер';
    return 'ночь';
  }
  function buildQuiet(){
    const pr = currentProfile(); const bucket = timeBucket();
    let w = { park:1.0, yard:1.1, foot:1.2, street:1.6, big:2.1, screens:2.4 };
    if(pr.noise){ w.street+=0.3; w.big+=0.5; }
    if(pr.crowd){ w.street+=0.3; w.big+=0.4; }
    if(pr.light){ w.screens+=0.6; }
    if(pr.cross){ w.big+=0.6; }
    if(pr.parks) w.park-=0.2; if(pr.yards) w.yard-=0.1; if(pr.paths) w.foot-=0.1;
    if(bucket==='вечер'){ w.street+=0.2; } if(bucket==='утро'){ w.park-=0.1; }

    const seg1 = document.getElementById('seg1');
    const seg2 = document.getElementById('seg2');
    const segBad = document.getElementById('segBad');

    if(seg1) seg1.setAttribute('stroke-dasharray', w.park+w.yard < 2.3 ? '' : '6 6');
    if(seg2) seg2.setAttribute('stroke-dasharray', w.foot < 1.25 ? '' : '6 6');
    if(segBad) segBad.setAttribute('stroke', (w.street+w.big>3.6) ? '#e03b5a88' : '#e0a75a88');

    const steps = document.getElementById('steps');
    if(steps){
      steps.innerHTML = `
        <div class="card"><strong>Через двор/вдоль домов</strong><div class="muted">вес ${(w.yard).toFixed(1)}</div></div>
        <div class="card"><strong>Тропа через парк</strong><div class="muted">${bucket}, ожидание людей — низкое · вес ${(w.park).toFixed(1)}</div></div>
        <div class="card"><strong>Небольшая улица</strong><div class="muted">минимум витрин · вес ${(w.street).toFixed(1)}</div></div>`;
    }
  }
  document.getElementById('build')?.addEventListener('click', buildQuiet);
  document.getElementById('alt')?.addEventListener('click', ()=>{
    const seg2 = document.getElementById('seg2');
    if(seg2) seg2.setAttribute('stroke-dasharray','8 8');
    alert('Показ альтернативного участка (демо)');
  });
  document.getElementById('exportRoute')?.addEventListener('click', ()=>{
    const txt = 'Маршрут A→B (тихий): двор → парк → малая улица. Настройки: '+JSON.stringify(currentProfile());
    const blob = new Blob([txt], {type:'text/plain'});
    const url=URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), {href:url, download:'quiet_route.txt'});
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
  document.getElementById('startNav')?.addEventListener('click', ()=>{
    location.hash = '#/alarm';
    alert('Демо: навигация запущена, в «Тревоге» можно позвать волонтёра.');
  });

  // ---- Places (mock POI) ----
  const poi=[{name:'Бәйтерек',addr:'пл. Независимости',tags:['park'],open:true,stress:0.12,x:420,y:120},
             {name:'Ботанический сад',addr:'ул. Туркестан',tags:['park','light'],open:true,stress:0.08,x:520,y:180},
             {name:'Хан Шатыр (тихая зона)',addr:'просп. Туран',tags:['music','light'],open:true,stress:0.20,x:350,y:110},
             {name:'Mega Silk Way (тихая зона)',addr:'EXPO',tags:['light'],open:true,stress:0.22,x:560,y:150},
             {name:'Набережная Есиля',addr:'левый берег',tags:['park'],open:true,stress:0.10,x:250,y:210},
             {name:'Библиотека №3',addr:'Сарыарка',tags:['music'],open:true,stress:0.09,x:180,y:220},
             {name:'Керуен (кафе без музыки)',addr:'просп. Достык',tags:['music','light'],open:true,stress:0.18,x:400,y:150}];

  const placeChips=[...document.querySelectorAll('#view-places .chip')];
  placeChips.forEach(c=>c.addEventListener('click',()=>{c.classList.toggle('active'); renderPlaces();}));

  function renderPlaces(){
    const on=placeChips.filter(c=>c.classList.contains('active')).map(c=>c.dataset.f);
    const list=poi.filter(p=>(on.includes('open')?p.open:true)
      &&(!on.includes('music')||p.tags.includes('music'))
      &&(!on.includes('light')||p.tags.includes('light'))
      &&(!on.includes('wc')||p.tags.includes('wc'))).sort((a,b)=>a.stress-b.stress);

    const box=document.getElementById('placeList'); if(box){ box.innerHTML=''; }
    list.forEach(p=>{
      const el=document.createElement('div'); el.className='card';
      const label=p.stress<0.15?'очень низкий':(p.stress<0.3?'низкий':'средний');
      el.innerHTML=`<strong>${p.name}</strong><div class="muted">${p.addr}</div>
        <div style="margin-top:6px" class="pill"><span class="dot"></span> стресс: ${(p.stress*100|0)} · ${label}</div>
        <div class="row" style="margin-top:8px">
          <a class="btn" href="#/routes">Идти сюда</a>
          <a class="btn secondary" href="#/crowd">Оставить отзыв</a>
        </div>`;
      if(box) box.appendChild(el);
    });
    const mk=document.getElementById('poiLayer'); if(mk){ mk.innerHTML='';
      list.forEach(p=>{const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',p.x); c.setAttribute('cy',p.y); c.setAttribute('r',6); c.setAttribute('fill','#18a999'); c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','2'); mk.appendChild(c);});
    }
  }
  renderPlaces();

  // ---- Planner ----
  const pd=document.getElementById('pDate'); if(pd) pd.value=new Date().toISOString().split('T')[0];

  document.getElementById('pSuggest')?.addEventListener('click', ()=>{
    const d = new Date(document.getElementById('pDate').value);
    const wd=[0,6].includes(d.getDay());
    const win=wd?'09:00–11:00':'10:30–12:00 или 14:30–16:30';
    document.getElementById('pOut').textContent='Рекомендованное тихое окно: '+win+'.';
  });
  document.getElementById('pSave')?.addEventListener('click', ()=>{
    const rec={date:document.getElementById('pDate').value,time:document.getElementById('pTime').value,A:document.getElementById('pA').value,B:document.getElementById('pB').value};
    try{ localStorage.setItem('qr_plan', JSON.stringify(rec)); }catch(e){}
    document.getElementById('pOut').textContent='Сохранено: '+rec.date+' '+rec.time+' · '+rec.A+' → '+rec.B;
  });
  document.getElementById('pExport')?.addEventListener('click', ()=>{
    const txt=document.getElementById('pOut').textContent||'Сначала сохраните маршрут';
    const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([txt],{type:'text/plain'})),download:'plan.txt'});
    document.body.appendChild(a); a.click(); a.remove();
  });

  // ---- Alarm & Volunteer ----
  document.getElementById('aSend')?.addEventListener('click', ()=>{
    const st=document.getElementById('aStatus'); if(st) st.textContent='Геолокация отправлена. Волонтёр в пути.';
    const p=document.getElementById('aProg'); let w=0; const t=setInterval(()=>{ w=Math.min(100,w+10); if(p) p.style.width=w+'%'; if(w===100) clearInterval(t); },700);
  });
  document.getElementById('aShare')?.addEventListener('click', ()=>{ const st=document.getElementById('aStatus'); if(st) st.textContent='Ссылка на маршрут отправлена доверенному контакту.'; });
  document.getElementById('aHelp')?.addEventListener('click', ()=>alert('Советы: отойти от дороги/экрана, наушники/беруши, дыхание 4-4-6.'));
  document.getElementById['aMeet']?.addEventListener?.('click', ()=>alert('Точка встречи: у входа №2.'));

  document.getElementById('vOpen')?.addEventListener('click', ()=>alert('Экран волонтёра открыт (демо).'));
  document.getElementById('codeOk')?.addEventListener('click', ()=>{
    const ok=(document.getElementById('code').value||'').trim().length>=4;
    document.getElementById('codeOut').textContent=ok?'Код подтверждён. Волонтёр верифицирован.':'Код слишком короткий.';
  });

  // ---- Crowd ----
  function getLS(k){ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return[]} }
  function setLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  document.getElementById('cSend')?.addEventListener('click', ()=>{
    const n=(document.getElementById('cName').value||'').trim(), a=(document.getElementById('cAddr').value||'').trim();
    if(!n||!a){ alert('Укажи название и адрес'); return; }
    const cats=[...document.querySelectorAll('[data-c].active')].map(x=>x.textContent);
    const desc=(document.getElementById('cDesc').value||'').trim();
    const items=getLS('qr_places'); items.unshift({name:n,addr:a,cats,desc,ts:Date.now(),stress:0.2,status:'pending'}); setLS('qr_places',items);
    const out=document.getElementById('cOut'); if(out) out.textContent='Отправлено на модерацию.'; renderFeed();
  });
  document.getElementById('cClear')?.addEventListener('click', ()=>{
    ['cName','cAddr','cDesc'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
    document.querySelectorAll('[data-c].active').forEach(x=>x.classList.remove('active'));
    const out=document.getElementById('cOut'); if(out) out.textContent='';
  });
  document.querySelectorAll('[data-c]').forEach(ch=>ch.addEventListener('click', ()=>ch.classList.toggle('active')));

  document.getElementById('rSend')?.addEventListener('click', ()=>{
    const place=(document.getElementById('rPlace').value||'').trim(); if(!place){ alert('Укажи место'); return; }
    const n=+document.getElementById('rN').value, c=+document.getElementById('rC').value, l=+document.getElementById('rL').value, txt=(document.getElementById('rTxt').value||'').trim();
    const items=getLS('qr_rates'); items.unshift({place,n,c,l,txt,ts:Date.now()}); setLS('qr_rates',items);
    const out=document.getElementById('rOut'); if(out) out.textContent='Спасибо! Оценка учтена.'; renderFeed();
  });

  document.getElementById('gSend')?.addEventListener('click', ()=>{
    const where=(document.getElementById('gWhere').value||'').trim();
    const what=(document.getElementById('gWhat').value||'').trim();
    if(!where||!what){ alert('Заполни адрес и описание'); return; }
    const type=document.getElementById('gType').value, when=document.getElementById('gWhen').value;
    const items=getLS('qr_issues'); items.unshift({where,what,type,when,ts:Date.now(),status:'pending'}); setLS('qr_issues',items);
    const out=document.getElementById('gOut'); if(out) out.textContent='Спасибо! Отправлено на проверку.'; renderFeed();
  });

  function seed(){
    if(!localStorage.getItem('qr_seeded')){
      setLS('qr_feed', [
        {name:'Кафе «Лимон»',desc:'без музыки, мягкий свет',stress:0.15,status:'approved'},
        {name:'Библиотека №3',desc:'читальный зал',stress:0.08,status:'approved'},
        {name:'Парк у озера',desc:'просторно утром',stress:0.10,status:'pending'},
        {name:'Кофейня «Сова»',desc:'шумно вечером у бара',stress:0.55,status:'flagged'}
      ]);
      localStorage.setItem('qr_seeded','1');
    }
  }
  function renderFeed(){
    seed();
    let feed=getLS('qr_feed');
    const added=getLS('qr_places').map(x=>({name:x.name,desc:(x.desc||x.addr),stress:x.stress,status:x.status}));
    const issues=getLS('qr_issues').map(x=>({name:x.where,desc:x.what,stress:0.6,status:'flagged'}));
    feed=[...added,...issues,...feed];
    const q=(document.getElementById('mQ')?.value||'').toLowerCase();
    const sort=document.getElementById('mSort')?.value||'new';
    let list=feed.filter(x=>(x.name+x.desc).toLowerCase().includes(q));
    if(sort==='calm') list.sort((a,b)=>a.stress-b.stress);
    if(sort==='stress') list.sort((a,b)=>b.stress-a.stress);
    const box=document.getElementById('mFeed'); if(!box) return; box.innerHTML='';
    list.forEach(i=>{
      const s=i.status==='approved'?'одобрено':(i.status==='flagged'?'проблема':'ожидает');
      const div=document.createElement('div'); div.className='card';
      div.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>${i.name}</strong><div class="muted">${i.desc}</div></div>
        <span class="pill"><span class="dot"></span> ${s} · стресс ${(i.stress*100|0)}</span>
      </div>
      <div class="row" style="margin-top:8px"><button class="btn secondary">Подробнее</button><button class="btn">Одобрить</button><button class="btn">Скрыть</button></div>`;
      box.appendChild(div);
    });
  }
  renderFeed();
});
</script>

</body>
</html>
